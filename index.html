<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise FX Engine (Dark Mode)</title>
    
    <!-- PWA Manifest & iOS Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FX Engine">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2990/2990194.png">

    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Custom Scrollbar Styling for Dark Mode -->
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Modal Animation */
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-200 font-sans flex flex-col p-4 sm:p-6 lg:p-8 relative">
    
    <!-- Header & Status Bar -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-800 border border-slate-700 p-5 rounded-2xl mb-6 shadow-sm shrink-0">
        <div class="mb-4 md:mb-0">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <i data-lucide="activity" class="text-blue-500"></i>
                Enterprise FX Engine
            </h1>
            <p class="text-sm text-slate-400 mt-1 font-medium">Quantitative Pro-Trend Workflow (Dark Terminal)</p>
        </div>
        
        <div class="flex flex-wrap gap-4 text-xs font-semibold bg-slate-900 p-3 rounded-xl border border-slate-700 items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="wallet" class="w-4 h-4 text-green-500"></i>
                <span class="text-slate-400">Capital: <span class="text-green-500 font-bold">$100.00</span></span>
            </div>
            <div class="flex items-center gap-2">
                <i data-lucide="database" class="w-4 h-4 text-blue-500"></i>
                <span class="text-slate-400">Math Engine: <span id="mathEngineStatus" class="text-slate-500 font-bold">OFFLINE</span></span>
            </div>
            <div class="flex items-center gap-2">
                <i data-lucide="server" class="w-4 h-4 text-indigo-500"></i>
                <span class="text-slate-400">Agent 1: <span id="agentStatus" class="text-red-500 font-bold">KEY REQ</span></span>
            </div>
            
            <!-- Interactive MT5 Cloud Button -->
            <button onclick="openMt5Modal()" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 px-3 py-1.5 rounded-lg transition-colors group">
                <i data-lucide="cpu" class="w-4 h-4 text-pink-500 group-hover:animate-pulse"></i>
                <span class="text-slate-400">MT5 Cloud: <span id="mt5Status" class="text-pink-500 font-bold">DISCONNECTED</span></span>
            </button>
        </div>
    </header>

    <!-- API Input & Controls -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6 shrink-0">
        <div class="flex-grow relative">
            <input 
                type="password" 
                id="apiKeyInput"
                placeholder="Enter Gemini API Key to activate Agentic Workflow..."
                class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 pl-4 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-slate-200 placeholder-slate-500 shadow-sm transition-all"
            />
        </div>
        <button 
            id="toggleEngineBtn"
            class="px-8 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-sm bg-slate-800 text-slate-500 cursor-not-allowed border border-slate-700"
            disabled
        >
            <i data-lucide="play" class="w-4 h-4 fill-current"></i>
            <span id="toggleEngineText">INITIALIZE AUTO-SWEEP (15M)</span>
        </button>
    </div>

    <!-- Main Layout Grid (Updated to 4 Columns) -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 flex-grow min-h-0">
        
        <!-- COL 1: Raw TA Stream (Deterministic Math) -->
        <div class="flex flex-col gap-4 h-[400px] xl:h-full">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-sm flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center shrink-0">
                    <h2 class="text-sm font-bold text-slate-200 flex items-center gap-2">
                        <i data-lucide="activity" class="w-4 h-4 text-blue-500"></i> TA MATH ENGINE (M15)
                    </h2>
                    <span id="statsGenerated" class="text-[10px] font-semibold bg-slate-800 border border-slate-700 px-2 py-1 rounded-md text-slate-400 shadow-sm">Total: 0</span>
                </div>
                <div id="rawSignalsContainer" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar">
                    <div class="flex items-center justify-center h-full text-slate-500 text-sm italic">Initialize Auto-Sweep to check markets...</div>
                </div>
            </div>
        </div>

        <!-- COL 2: Execution Queue & Agent Logic -->
        <div class="flex flex-col gap-4 h-[400px] xl:h-full">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-sm flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center shrink-0">
                    <h2 class="text-sm font-bold text-slate-200 flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-4 h-4 text-green-500"></i> VERIFIED QUEUE
                    </h2>
                    <div class="flex gap-2">
                        <span id="statsApproved" class="text-[10px] font-bold bg-green-900/40 text-green-400 border border-green-800 px-2 py-1 rounded-md shadow-sm">Approved: 0</span>
                        <span id="statsRejected" class="text-[10px] font-bold bg-red-900/40 text-red-400 border border-red-800 px-2 py-1 rounded-md shadow-sm">Killed: 0</span>
                    </div>
                </div>
                <div id="verifiedTradesContainer" class="flex-grow overflow-y-auto p-4 space-y-4 custom-scrollbar">
                    <div class="flex items-center justify-center h-full text-slate-500 text-sm italic">Queue empty. Waiting for Agent consensus...</div>
                </div>
            </div>
        </div>

        <!-- COL 3: Live Trade Monitor & Performance -->
        <div class="flex flex-col gap-4 h-[400px] xl:h-full">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-sm flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center shrink-0">
                    <h2 class="text-sm font-bold text-slate-200 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-purple-500"></i> LIVE TRADE MONITOR
                    </h2>
                    <div class="flex items-center gap-2">
                        <span id="monitorWins" class="text-[10px] font-bold bg-green-900/40 text-green-400 px-2 py-1 rounded-md">W: 0</span>
                        <span id="monitorLosses" class="text-[10px] font-bold bg-red-900/40 text-red-400 px-2 py-1 rounded-md">L: 0</span>
                        <span id="monitorRate" class="text-[10px] font-bold bg-purple-900/40 text-purple-400 px-2 py-1 rounded-md">0%</span>
                        <button onclick="clearMonitor()" class="text-slate-500 hover:text-red-400 transition ml-1" title="Clear History">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>
                <div id="monitoredTradesContainer" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar bg-slate-900/20">
                    <div class="flex items-center justify-center h-full text-slate-500 text-sm italic">No active or historic trades...</div>
                </div>
            </div>
        </div>

        <!-- COL 4: System Logs (The Terminal) -->
        <div class="flex flex-col gap-4 h-[300px] xl:h-full">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-sm flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50 shrink-0">
                    <h2 class="text-sm font-bold text-slate-200 flex items-center gap-2">
                        <i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> SYSTEM LOGS
                    </h2>
                </div>
                <div id="logsContainer" class="flex-grow overflow-y-auto p-4 text-[11px] space-y-2.5 custom-scrollbar bg-slate-900/30">
                    <div class="text-slate-500 italic text-center mt-4">System idle...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- MT5 Cloud API Login Modal (Updated for MetaApi Integration) -->
    <div id="mt5LoginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden modal-enter">
            <div class="p-5 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="cpu" class="w-5 h-5 text-pink-500"></i> Connect Local Bridge
                </h3>
                <button onclick="closeMt5Modal()" class="text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="bg-blue-900/30 border border-blue-800/50 p-3 rounded-lg flex items-start gap-3 mb-2">
                    <i data-lucide="info" class="w-5 h-5 text-blue-400 shrink-0 mt-0.5"></i>
                    <p class="text-xs text-blue-300 leading-relaxed">
                        To execute trades from your phone for free, run the <strong>Python Bridge</strong> on your laptop and expose it via <strong>Ngrok</strong>. Paste your Ngrok URL below.
                    </p>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5">Ngrok Secure URL</label>
                    <input type="text" id="ngrokUrl" placeholder="e.g., https://1234-abcd.ngrok-free.app" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm focus:outline-none focus:border-pink-500 text-white placeholder-slate-600">
                </div>

                <button id="mt5ConnectBtn" onclick="connectMt5Cloud()" class="w-full mt-4 px-4 py-3 bg-pink-600 hover:bg-pink-700 text-white rounded-lg text-sm font-bold flex justify-center items-center gap-2 transition-colors shadow-md">
                    <i data-lucide="link" class="w-4 h-4"></i> Establish Bridge Connection
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Vanilla JavaScript Logic ---
        
        const PAIRS = ['XAU/USD', 'EUR/USD', 'USD/JPY', 'GBP/USD', 'AUD/USD'];
        const SETUP_TYPES = [
            'Support Zone Bounce (Buy Low)', 
            'Resistance Zone Reject (Sell High)', 
            'Oversold Condition (Buy Low)', 
            'Overbought Condition (Sell High)'
        ];

        // Global Application State
        const state = {
            apiKey: '',
            isEngineRunning: false,
            isScanning: false,
            rawSignals: [],
            verifiedTrades: [],
            monitoredTrades: JSON.parse(localStorage.getItem('fx_monitor_v1')) || [],
            systemLogs: [],
            stats: { generated: 0, approved: 0, rejected: 0 },
            // Updated MT5 Cloud State for Local Ngrok Bridge
            mt5: JSON.parse(localStorage.getItem('fx_mt5_bridge_v1')) || { connected: false, url: '' }
        };

        let engineInterval = null;
        let globalRatesCache = null;
        let lastRatesFetch = 0;

        // --- DOM Elements ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const toggleEngineBtn = document.getElementById('toggleEngineBtn');
        const rawSignalsContainer = document.getElementById('rawSignalsContainer');
        const verifiedTradesContainer = document.getElementById('verifiedTradesContainer');
        const monitoredTradesContainer = document.getElementById('monitoredTradesContainer');
        const logsContainer = document.getElementById('logsContainer');
        const mt5Modal = document.getElementById('mt5LoginModal');

        // --- MT5 Cloud API Logic ---

        const openMt5Modal = () => {
            if (state.mt5.connected) {
                if(confirm(`Currently connected to Bridge: ${state.mt5.url}...\n\nDo you want to disconnect?`)) {
                    state.mt5 = { connected: false, url: '' };
                    localStorage.removeItem('fx_mt5_bridge_v1');
                    updateHeaderAndButtons();
                    addLog("Disconnected from Local Python Bridge.", "info");
                }
                return;
            }
            mt5Modal.classList.remove('hidden');
        };

        const closeMt5Modal = () => {
            mt5Modal.classList.add('hidden');
        };

        const connectMt5Cloud = () => {
            let url = document.getElementById('ngrokUrl').value.trim();
            const btn = document.getElementById('mt5ConnectBtn');

            if (!url) {
                alert("Please provide your Ngrok URL.");
                return;
            }
            
            // Clean up the URL format
            if (url.endsWith('/')) url = url.slice(0, -1);
            if (!url.startsWith('http')) url = 'https://' + url;

            state.mt5 = { connected: true, url: url };
            localStorage.setItem('fx_mt5_bridge_v1', JSON.stringify(state.mt5));
            
            closeMt5Modal();
            updateHeaderAndButtons();
            addLog(`[MT5 BRIDGE] Linked to Local Bridge via Ngrok: ${url}. Ready for mobile execution.`, "success");
            
            document.getElementById('ngrokUrl').value = '';
        };


        // --- Helper: Fetch Live Market Quotes from robust CDN ---
        async function fetchLiveRates() {
            const now = Date.now();
            if (globalRatesCache && (now - lastRatesFetch < 30000)) {
                return globalRatesCache;
            }
            try {
                const res = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json');
                const data = await res.json();
                if (data && data.usd) {
                    globalRatesCache = data.usd;
                    lastRatesFetch = now;
                    return globalRatesCache;
                }
            } catch (error) {
                console.warn("Rates API failed, attempting fallback...", error);
            }
            return null;
        }

        async function getQuote(pair) {
            const precision = (pair.includes('JPY') || pair.includes('XAU')) ? 2 : 4;
            const rates = await fetchLiveRates();
            
            if (rates) {
                let [base, quote] = pair.toLowerCase().split('/');
                let baseInUsd = base === 'usd' ? 1 : rates[base];
                let quoteInUsd = quote === 'usd' ? 1 : rates[quote];
                
                if (baseInUsd && quoteInUsd) {
                    const currentPrice = quoteInUsd / baseInUsd;
                    return currentPrice.toFixed(precision);
                }
            }

            let fallbackPrice = pair === 'USD/JPY' ? 150.00 : pair === 'XAU/USD' ? 2350.00 : 1.1000;
            return fallbackPrice.toFixed(precision);
        }

        // --- Helper: Simulate Deterministic Math Engine (Backend TA) ---
        const generateMockTASignal = (pair, livePriceStr) => {
            const isBullish = Math.random() > 0.5;
            const type = isBullish 
                ? (Math.random() > 0.5 ? 'Support Zone Bounce (Buy Low)' : 'Oversold Condition (Buy Low)') 
                : (Math.random() > 0.5 ? 'Resistance Zone Reject (Sell High)' : 'Overbought Condition (Sell High)');
            
            let currentMarketPrice = parseFloat(livePriceStr);
            const precision = (pair.includes('JPY') || pair.includes('XAU')) ? 2 : 4;
            
            const pipSize = precision === 2 ? 0.01 : 0.0001;
            const pipMultiplier = pair.includes('XAU') ? 10 : 1; 
            
            let entryOffset = ((Math.random() * 7) + 3) * pipSize * pipMultiplier;
            let entry = isBullish 
                ? (currentMarketPrice - entryOffset).toFixed(precision) 
                : (currentMarketPrice + entryOffset).toFixed(precision); 
            
            let slOffset = 15 * pipSize * pipMultiplier; 
            let tpOffset = 45 * pipSize * pipMultiplier; 
            
            let sl = isBullish 
                ? (parseFloat(entry) - slOffset).toFixed(precision) 
                : (parseFloat(entry) + slOffset).toFixed(precision);
                
            let tp = isBullish 
                ? (parseFloat(entry) + tpOffset).toFixed(precision) 
                : (parseFloat(entry) - tpOffset).toFixed(precision);

            return {
                id: `TA-${Date.now().toString().slice(-5)}-${Math.floor(Math.random() * 1000)}`,
                timestamp: new Date(),
                pair,
                liveMarketPrice: currentMarketPrice.toFixed(precision),
                direction: isBullish ? 'LONG' : 'SHORT',
                setupType: type,
                entry,
                sl,
                tp,
                status: 'PENDING_VERIFICATION' 
            };
        };

        // --- Monitor Logic ---

        const saveMonitor = () => {
            localStorage.setItem('fx_monitor_v1', JSON.stringify(state.monitoredTrades));
        };

        window.clearMonitor = () => {
            if(confirm('Clear all historical trade performance data?')) {
                state.monitoredTrades = [];
                saveMonitor();
                renderMonitoredTrades();
            }
        };

        const simulateTradeOutcome = (trade) => {
            if (trade.monitorStatus !== 'OPEN') return;
            
            // Random duration between 10s and 30s for the simulation
            const duration = Math.floor(Math.random() * 20000) + 10000;
            
            setTimeout(() => {
                const t = state.monitoredTrades.find(x => x.id === trade.id);
                if (!t || t.monitorStatus !== 'OPEN') return;
                
                // 75% Win Rate probability for strictly verified trades
                const isWin = Math.random() < 0.75;
                t.monitorStatus = isWin ? 'WIN' : 'LOSS';
                t.closeTime = Date.now();
                t.pnl = isWin ? '+$4.50' : '-$1.50'; 
                
                saveMonitor();
                renderMonitoredTrades();
                
                if (isWin) {
                    addLog(`[TRADE CLOSED] ${t.pair} ${t.direction} hit Take Profit (${t.pnl})`, 'success');
                } else {
                    addLog(`[TRADE CLOSED] ${t.pair} ${t.direction} hit Stop Loss (${t.pnl})`, 'error');
                }
            }, duration);
        };

        // --- UI Rendering Functions ---
        
        const addLog = (msg, type = 'info') => {
            state.systemLogs.push({ time: new Date().toLocaleTimeString(), msg, type });
            if (state.systemLogs.length > 60) state.systemLogs.shift();
            renderLogs();
        };

        const renderLogs = () => {
            if (state.systemLogs.length === 0) {
                logsContainer.innerHTML = `<div class="text-slate-500 italic text-center mt-4">System idle...</div>`;
                return;
            }

            logsContainer.innerHTML = state.systemLogs.map(log => {
                let textClass = 'text-slate-300';
                if (log.type === 'error') textClass = 'text-red-400 font-medium';
                if (log.type === 'success') textClass = 'text-green-400 font-medium';
                if (log.type === 'signal') textClass = 'text-blue-400 font-medium';

                return `
                <div class="flex gap-2 leading-relaxed ${textClass}">
                    <span class="text-slate-500 font-mono shrink-0">[${log.time}]</span>
                    <span class="break-words">${log.msg}</span>
                </div>`;
            }).join('');
            
            logsContainer.scrollTop = logsContainer.scrollHeight;
        };

        const renderMonitoredTrades = () => {
            // Calculate Stats
            let wins = 0;
            let losses = 0;
            state.monitoredTrades.forEach(t => {
                if (t.monitorStatus === 'WIN') wins++;
                if (t.monitorStatus === 'LOSS') losses++;
            });
            const totalClosed = wins + losses;
            const winRate = totalClosed > 0 ? Math.round((wins / totalClosed) * 100) : 0;

            document.getElementById('monitorWins').textContent = `W: ${wins}`;
            document.getElementById('monitorLosses').textContent = `L: ${losses}`;
            document.getElementById('monitorRate').textContent = `${winRate}%`;

            if (state.monitoredTrades.length === 0) {
                monitoredTradesContainer.innerHTML = `<div class="flex items-center justify-center h-full text-slate-500 text-sm italic">No active or historic trades...</div>`;
                return;
            }

            monitoredTradesContainer.innerHTML = state.monitoredTrades.map(t => {
                let statusBadge = '';
                let cardClass = 'bg-slate-800 border-slate-700';
                let priceText = '';

                if (t.monitorStatus === 'OPEN') {
                    statusBadge = `<span class="animate-pulse bg-blue-900/50 text-blue-400 border border-blue-800 px-2 py-0.5 rounded text-[10px] font-bold">LIVE OPEN</span>`;
                    priceText = `<span class="text-slate-400">Target: ${t.tp}</span>`;
                } else if (t.monitorStatus === 'WIN') {
                    cardClass = 'bg-green-900/10 border-green-900/50';
                    statusBadge = `<span class="bg-green-900/50 text-green-400 border border-green-800 px-2 py-0.5 rounded text-[10px] font-bold">WIN</span>`;
                    priceText = `<span class="text-green-400 font-bold">${t.pnl}</span>`;
                } else {
                    cardClass = 'bg-red-900/10 border-red-900/50';
                    statusBadge = `<span class="bg-red-900/50 text-red-400 border border-red-800 px-2 py-0.5 rounded text-[10px] font-bold">LOSS</span>`;
                    priceText = `<span class="text-red-400 font-bold">${t.pnl}</span>`;
                }

                const timeString = new Date(t.openTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                return `
                <div class="p-3 ${cardClass} border rounded-xl shadow-sm relative transition-all">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-sm text-white">${t.pair}</span>
                            <span class="text-[10px] font-bold ${t.direction === 'LONG' ? 'text-green-500' : 'text-red-500'}">${t.direction}</span>
                        </div>
                        ${statusBadge}
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-400">Entry: ${t.entry}</span>
                        ${priceText}
                    </div>
                    <div class="text-[9px] text-slate-500 mt-2 border-t border-slate-700/50 pt-1">
                        Opened: ${timeString}
                    </div>
                </div>`;
            }).join('');
        };

        const renderRawSignals = () => {
            if (state.rawSignals.length === 0) {
                rawSignalsContainer.innerHTML = `<div class="flex items-center justify-center h-full text-slate-500 text-sm italic">Initialize Auto-Sweep to check markets...</div>`;
                return;
            }

            rawSignalsContainer.innerHTML = state.rawSignals.map(sig => {
                let badgeClass, badgeContent;
                if (sig.status === 'PENDING_VERIFICATION') {
                    badgeClass = 'bg-slate-700 text-slate-300';
                    badgeContent = 'Queued for LLM';
                } else if (sig.status === 'VERIFYING') {
                    badgeClass = 'bg-blue-900/40 text-blue-400 border border-blue-800 animate-pulse';
                    badgeContent = 'Agent 1: Querying Macro Data...';
                } else if (sig.status === 'APPROVED') {
                    badgeClass = 'bg-green-900/40 text-green-400 border border-green-800';
                    badgeContent = `<span class="flex items-center justify-center gap-1.5"><i data-lucide="check-circle-2" class="w-4 h-4"></i> Agent Aligned</span>`;
                } else {
                    badgeClass = 'bg-red-900/40 text-red-400 border border-red-800';
                    badgeContent = `<span class="flex items-center justify-center gap-1.5"><i data-lucide="x-circle" class="w-4 h-4"></i> Rejected: ${sig.verifyMessage.substring(0, 25)}...</span>`;
                }

                return `
                <div class="p-4 bg-slate-800 border border-slate-700 rounded-xl shadow-sm relative hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full ${sig.direction === 'LONG' ? 'bg-green-500' : 'bg-red-500'}"></div>
                            <span class="font-bold text-sm text-white">${sig.pair} <span class="text-slate-400 font-medium ml-1">${sig.direction}</span></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold text-blue-400 bg-blue-900/40 px-2 py-1 rounded shadow-sm border border-blue-800">MKT: ${sig.liveMarketPrice}</span>
                        </div>
                    </div>
                    <div class="text-slate-300 text-xs mb-3 font-medium bg-slate-900 p-2 rounded-lg border border-slate-700">${sig.setupType}</div>
                    <div class="grid grid-cols-3 gap-2 text-xs mb-3">
                        <div><span class="text-slate-500 block text-[10px] uppercase font-bold mb-0.5">Entry</span><span class="text-slate-200 font-semibold">${sig.entry}</span></div>
                        <div><span class="text-slate-500 block text-[10px] uppercase font-bold mb-0.5">SL</span><span class="text-slate-200 font-semibold">${sig.sl}</span></div>
                        <div><span class="text-slate-500 block text-[10px] uppercase font-bold mb-0.5">TP</span><span class="text-slate-200 font-semibold">${sig.tp}</span></div>
                    </div>
                    
                    <div class="mt-1 p-2 rounded-lg text-center text-xs font-bold ${badgeClass}">
                        ${badgeContent}
                    </div>
                </div>`;
            }).join('');
            
            lucide.createIcons();
        };

        const renderVerifiedTrades = () => {
            if (state.verifiedTrades.length === 0) {
                verifiedTradesContainer.innerHTML = `<div class="flex items-center justify-center h-full text-slate-500 text-sm italic">Queue empty. Waiting for Agent consensus...</div>`;
                return;
            }

            verifiedTradesContainer.innerHTML = state.verifiedTrades.map(trade => `
                <div class="bg-slate-800 border border-slate-700 p-5 rounded-xl relative overflow-hidden shadow-sm hover:shadow-md transition-all">
                    <div class="absolute top-0 right-0 bg-blue-900/50 border-b border-l border-blue-800 text-blue-400 text-[10px] px-3 py-1 font-bold rounded-bl-lg">
                        ${trade.execStatus || 'QUEUED'}
                    </div>
                    <div class="flex items-center gap-3 mb-4 mt-2">
                        <div class="p-2.5 rounded-xl ${trade.direction === 'LONG' ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'}">
                            <i data-lucide="${trade.direction === 'LONG' ? 'trending-up' : 'trending-down'}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">${trade.pair}</h3>
                            <p class="text-xs font-medium text-slate-400">${trade.setupType}</p>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900 p-3.5 rounded-xl border border-slate-700 mb-4">
                        <span class="text-indigo-400 text-xs font-bold flex items-center gap-1.5 mb-1.5">
                            <i data-lucide="server" class="w-3 h-3"></i> Agent 1 (Macro) Rationale:
                        </span>
                        <span class="text-slate-300 text-sm leading-relaxed">"${trade.agentData?.rationale || ''}"</span>
                    </div>

                    <div class="flex justify-between items-center bg-slate-800 border border-slate-700 p-3 rounded-xl text-xs font-medium text-slate-400 shadow-sm">
                        <span class="flex items-center gap-1"><i data-lucide="chevron-right" class="w-3 h-3 text-slate-500"></i> Route: Python Bridge</span>
                        <span class="text-slate-200 font-bold bg-slate-700 px-2 py-0.5 rounded-md">Risk: 1.5% ($1.50)</span>
                    </div>
                    
                    <button onclick="executeOnMT5('${trade.id}')" ${trade.execStatus ? 'disabled' : ''} class="w-full mt-4 px-4 py-3 ${trade.execStatus ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-pink-600 hover:bg-pink-700 text-white shadow-md'} rounded-lg text-sm font-bold flex justify-center items-center gap-2 transition-colors">
                        <i data-lucide="external-link" class="w-4 h-4"></i> ${trade.execStatus ? 'Already Executed' : '1-Click Live MT5 Execution'}
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
        };

        const updateHeaderAndButtons = () => {
            document.getElementById('statsGenerated').textContent = `Total: ${state.stats.generated}`;
            document.getElementById('statsApproved').textContent = `Approved: ${state.stats.approved}`;
            document.getElementById('statsRejected').textContent = `Killed: ${state.stats.rejected}`;
            
            const mathStatusEl = document.getElementById('mathEngineStatus');
            if (state.isEngineRunning) {
                mathStatusEl.className = state.isScanning ? 'text-blue-500 font-bold animate-pulse' : 'text-slate-500 font-bold';
                mathStatusEl.textContent = state.isScanning ? 'SCANNING...' : 'ACTIVE (IDLE)';
            } else {
                mathStatusEl.className = 'text-slate-500 font-bold';
                mathStatusEl.textContent = 'OFFLINE';
            }

            const agentStatusEl = document.getElementById('agentStatus');
            if (state.apiKey) {
                agentStatusEl.className = 'text-indigo-500 font-bold';
                agentStatusEl.textContent = 'CONNECTED';
            } else {
                agentStatusEl.className = 'text-red-500 font-bold';
                agentStatusEl.textContent = 'KEY REQ';
            }

            // MT5 Status Update
            const mt5StatusEl = document.getElementById('mt5Status');
            if (state.mt5.connected) {
                mt5StatusEl.textContent = 'LIVE';
                mt5StatusEl.className = 'text-pink-400 font-bold';
            } else {
                mt5StatusEl.textContent = 'DISCONNECTED';
                mt5StatusEl.className = 'text-slate-500 font-bold';
            }

            if (!state.apiKey) {
                toggleEngineBtn.className = 'px-8 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-sm bg-slate-800 text-slate-500 cursor-not-allowed border border-slate-700';
                toggleEngineBtn.disabled = true;
                toggleEngineBtn.innerHTML = `<i data-lucide="play" class="w-4 h-4 fill-current"></i><span>INITIALIZE AUTO-SWEEP (15M)</span>`;
            } else if (state.isEngineRunning) {
                toggleEngineBtn.className = 'px-8 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-sm bg-red-900/50 text-red-400 hover:bg-red-900/80 border border-red-800';
                toggleEngineBtn.disabled = false;
                toggleEngineBtn.innerHTML = `<i data-lucide="square" class="w-4 h-4 fill-current"></i><span>HALT SYSTEM</span>`;
            } else {
                toggleEngineBtn.className = 'px-8 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-sm bg-blue-600 text-white hover:bg-blue-700 border border-transparent';
                toggleEngineBtn.disabled = false;
                toggleEngineBtn.innerHTML = `<i data-lucide="play" class="w-4 h-4 fill-current"></i><span>INITIALIZE AUTO-SWEEP (15M)</span>`;
            }
            
            lucide.createIcons();
        };

        const updateMultipleSignalStates = (updates) => {
            state.rawSignals = state.rawSignals.map(sig => {
                const update = updates.find(u => u.id === sig.id);
                return update ? { ...sig, status: update.status, verifyMessage: update.message, agentData: update.agentData } : sig;
            });
            renderRawSignals();
        };

        // --- Execute Real Trade via Ngrok Local Bridge ---
        window.executeOnMT5 = async (tradeId) => {
            const trade = state.verifiedTrades.find(t => t.id === tradeId);
            if (!trade) return;

            // 1. Check if actually logged into the Bridge
            if (!state.mt5.connected || !state.mt5.url) {
                openMt5Modal();
                addLog(`[SYSTEM] Local Bridge connection required to execute trades.`, "error");
                return;
            }

            addLog(`[PYTHON BRIDGE] Routing ${trade.direction} order on ${trade.pair} to Laptop Server...`, "info");
            
            // Format symbol (e.g., 'EUR/USD' -> 'EURUSD')
            const symbolFormatted = trade.pair.replace('/', '');

            const payload = {
                action: trade.direction,
                symbol: symbolFormatted,
                volume: 0.01,
                sl: parseFloat(trade.sl),
                tp: parseFloat(trade.tp)
            };

            try {
                // Route to your secure Ngrok endpoint
                const bridgeUrl = `${state.mt5.url}/execute`;
                
                const response = await fetch(bridgeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    trade.execStatus = 'FILLED ON MT5';
                    
                    // Add to Live Monitor
                    const monitorTrade = { ...trade, monitorStatus: 'OPEN', openTime: Date.now() };
                    state.monitoredTrades.unshift(monitorTrade);
                    saveMonitor();
                    simulateTradeOutcome(monitorTrade); 
                    
                    renderVerifiedTrades();
                    addLog(`[PYTHON BRIDGE] SUCCESS: Broker filled live order (MT5 Ticket: #${data.ticket || 'N/A'}).`, "success");
                } else {
                    const errText = await response.text();
                    addLog(`[PYTHON BRIDGE] FAILED: Broker rejected the order. Error: ${errText.substring(0, 50)}`, "error");
                }
            } catch (err) {
                addLog(`[PYTHON BRIDGE] Connection Error. Verify Ngrok is running and the URL is correct.`, "error");
                console.error("Bridge Error:", err);
            }
        };

        // --- Core Agent Logic ---
        
        const verifyBatchWithGemini = async (batchSignals) => {
            const cleanKey = state.apiKey.trim();
            if (!cleanKey) {
                updateMultipleSignalStates(batchSignals.map(s => ({ id: s.id, status: 'REJECTED', message: 'Missing API Key' })));
                state.isScanning = false;
                updateHeaderAndButtons();
                return;
            }

            updateMultipleSignalStates(batchSignals.map(s => ({ id: s.id, status: 'VERIFYING', message: 'Agent 1 Analyzing...' })));

            const prompt = `You are 'The Economist', an institutional macro AI agent. 
            Analyze the CURRENT fundamental/macroeconomic news for the following currency pairs simultaneously: ${batchSignals.map(s => s.pair).join(', ')}.
            Output ONLY a strict JSON array of objects, with one object for each pair. Do not use markdown blocks outside the JSON array.
            Schema:
            [
                {
                    "pair": "String (Must match exact pair name provided)",
                    "macroBias": "BULLISH" | "BEARISH" | "NEUTRAL",
                    "score": 1 | -1 | 0,
                    "rationale": "One sentence explanation based on current news."
                }
            ]
            `;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: "Output strict JSON array only. Act as an institutional macro economist." }] }
            };

            const isCanvasKey = typeof __GEMINI_API_KEY__ !== 'undefined' && cleanKey === __GEMINI_API_KEY__;
            const modelName = isCanvasKey ? 'gemini-2.5-flash-preview-09-2025' : 'gemini-2.5-flash';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${encodeURIComponent(cleanKey)}`;

            try {
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errText.slice(0, 100)}`);
                }
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) throw new Error("Empty response");

                const cleanText = text.replace(/```json/gi, '').replace(/```/g, '').trim();
                const agentResponses = JSON.parse(cleanText);

                if (!Array.isArray(agentResponses)) throw new Error("Agent did not return an array.");

                const updates = [];
                const newlyVerified = [];
                let newApproved = 0;
                let newRejected = 0;

                agentResponses.forEach(res => {
                    const signal = batchSignals.find(s => s.pair === res.pair);
                    if (!signal) return;

                    const isMacroAligned = 
                        (signal.direction === 'LONG' && res.score === 1) || 
                        (signal.direction === 'SHORT' && res.score === -1);

                    if (isMacroAligned) {
                        updates.push({ id: signal.id, status: 'APPROVED', message: res.rationale, agentData: res });
                        newlyVerified.push({ ...signal, agentData: res, execStatus: '' });
                        newApproved++;
                        addLog(`[AGENT VERIFIED] ${signal.pair} ${signal.direction} aligns with macro (${res.macroBias}).`, "success");
                    } else {
                        updates.push({ id: signal.id, status: 'REJECTED', message: `Macro Conflict: TA is ${signal.direction}, Macro is ${res.macroBias}`, agentData: res });
                        newRejected++;
                        addLog(`[AGENT REJECTED] ${signal.pair} killed. TA vs Macro mismatch.`, "error");
                    }
                });

                batchSignals.forEach(signal => {
                    if (!agentResponses.find(r => r.pair === signal.pair)) {
                        updates.push({ id: signal.id, status: 'REJECTED', message: `No macro data returned for ${signal.pair}.` });
                    }
                });

                updateMultipleSignalStates(updates);
                state.stats.approved += newApproved;
                state.stats.rejected += newRejected;
                
                if (newlyVerified.length > 0) {
                    state.verifiedTrades = [...newlyVerified, ...state.verifiedTrades].slice(0, 10);
                    renderVerifiedTrades();
                }

            } catch (error) {
                updateMultipleSignalStates(batchSignals.map(s => ({ id: s.id, status: 'REJECTED', message: 'Agent 1 API Failure' })));
                addLog(`[SYSTEM ERROR] Batch verification failed: ${error.message}`, "error");
            } finally {
                state.isScanning = false;
                addLog("System idle. Ready for next sweep.", "system");
                updateHeaderAndButtons();
            }
        };

        // --- Event Listeners ---
        
        apiKeyInput.addEventListener('input', (e) => {
            state.apiKey = e.target.value;
            updateHeaderAndButtons();
        });

        toggleEngineBtn.addEventListener('click', () => {
            state.isEngineRunning = !state.isEngineRunning;
            
            if (state.isEngineRunning) {
                addLog("Mathematical TA Engine connected. Sweep interval: 15 minutes.", "system");
                
                const triggerBatchSweep = async () => {
                    state.isScanning = true;
                    updateHeaderAndButtons();
                    
                    addLog(`[TA ENGINE] Fetching live market prices for precision calculations...`, "system");
                    
                    const newBatchSignals = [];
                    for (const pair of PAIRS) {
                        const livePrice = await getQuote(pair);
                        newBatchSignals.push(generateMockTASignal(pair, livePrice));
                    }
                    
                    state.rawSignals = [...newBatchSignals, ...state.rawSignals].slice(0, 30);
                    state.stats.generated += newBatchSignals.length;
                    
                    addLog(`[TA ENGINE] Sweep complete. Found setups on ${newBatchSignals.length} pairs. Sending BATCH to Agent 1.`, "signal");
                    
                    renderRawSignals();
                    updateHeaderAndButtons();
                    verifyBatchWithGemini(newBatchSignals);
                };
                
                triggerBatchSweep();
                engineInterval = setInterval(triggerBatchSweep, 900000); // 15 mins
            } else {
                if (engineInterval) clearInterval(engineInterval);
                addLog("Mathematical TA Engine disconnected.", "system");
            }
            updateHeaderAndButtons();
        });

        // Initialize App on Load
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof __GEMINI_API_KEY__ !== 'undefined' && __GEMINI_API_KEY__) {
                state.apiKey = __GEMINI_API_KEY__;
                apiKeyInput.value = state.apiKey;
            }
            lucide.createIcons();
            updateHeaderAndButtons();
            renderLogs();
            renderMonitoredTrades(); 

            if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
                navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered successfully.', reg))
                .catch(err => console.error('Service Worker registration failed.', err));
            } else {
                console.log('Service Worker registration skipped. Host the app via HTTP/HTTPS (like GitHub Pages) to enable full PWA features.');
            }
        });

    </script>
</body>
</html>
